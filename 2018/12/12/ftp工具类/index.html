<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>ftp工具类 | 你的ENTER键价值千亿</title>
  <meta name="author" content="JosephGK">
  
  <meta name="description" content="gekun,葛坤">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="ftp工具类">
  <meta property="og:site_name" content="你的ENTER键价值千亿">

  
    <meta property="og:image" content="">
  

  <link href="/Blog/favicon.png" rel="icon">
  <link rel="alternate" href="/Blog/atom.xml" title="你的ENTER键价值千亿" type="application/atom+xml">
  <link rel="stylesheet" href="/Blog/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>
</html>

<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/Blog/">你的ENTER键价值千亿</a></h1>
  <h2><a href="/Blog/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/Blog/">主页</a></li>
    
      <li><a href="/Blog/archives">文档</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-12-11T16:00:00.000Z"><a href="/Blog/2018/12/12/ftp工具类/">2018-12-12</a></time>
      
      
  
    <h1 class="title">ftp工具类</h1>
  

    </header>
    <div class="entry">
      
        <pre><code>public class FtpCli {
    private static final String DEFAULT_CHARSET = &quot;UTF-8&quot;;
    private static final int DEFAULT_TIMEOUT = 60 * 1000;
    private static final String DAILY_FILE_PATH = &quot;dailyFilePath&quot;;
    private final String host;
    private final int port;
    private final String username;
    private final String password;
    private FTPClient ftpClient;
    private volatile String ftpBasePath;

private FtpCli(String host, String username, String password) {
    this(host, 21, username, password, DEFAULT_CHARSET);
    setTimeout(DEFAULT_TIMEOUT, DEFAULT_TIMEOUT, DEFAULT_TIMEOUT);
}

private FtpCli(String host, int port, String username, String password, String charset) {
    ftpClient = new FTPClient();
    ftpClient.setControlEncoding(charset);
    this.host = StringUtils.isEmpty(host) ? &quot;localhost&quot; : host;
    this.port = (port &lt;= 0) ? 21 : port;
    this.username = StringUtils.isEmpty(username) ? &quot;anonymous&quot; : username;
    this.password = password;
}

/**
 * 创建默认的ftp客户端
 * @param host     主机名或者ip地址
 * @param username ftp用户名
 * @param password ftp密码
 */
public static FtpCli createFtpCli(String host, String username, String password) {
    return new FtpCli(host, username, password);
}

/**
 * 创建自定义属性的ftp客户端
 * @param host     主机名或者ip地址
 * @param port     ftp端口
 * @param username ftp用户名
 * @param password ftp密码
 * @param charset  字符集
 */
public static FtpCli createFtpCli(String host, int port, String username, String password, String charset) {
    return new FtpCli(host, port, username, password, charset);
}

/**
 * 设置超时时间
 * @param defaultTimeout 超时时间
 * @param connectTimeout 超时时间
 * @param dataTimeout    超时时间
 */
public void setTimeout(int defaultTimeout, int connectTimeout, int dataTimeout) {
    ftpClient.setDefaultTimeout(defaultTimeout);
    ftpClient.setConnectTimeout(connectTimeout);
    ftpClient.setDataTimeout(dataTimeout);
}

/**
 * 连接到ftp
 */
public void connect() throws IOException {
    try {
        ftpClient.connect(host, port);
    } catch (UnknownHostException e) {
        throw new IOException(&quot;Can&apos;t find FTP server :&quot; + host);
    }

    int reply = ftpClient.getReplyCode();
    if (!FTPReply.isPositiveCompletion(reply)) {
        disconnect();
        throw new IOException(&quot;Can&apos;t connect to server :&quot; + host);
    }

    if (!ftpClient.login(username, password)) {
        disconnect();
        throw new IOException(&quot;Can&apos;t login to server :&quot; + host);
    }

    // set data transfer mode.
    ftpClient.setFileType(FTP.BINARY_FILE_TYPE);

    // Use passive mode to pass firewalls.
    ftpClient.enterLocalPassiveMode();

    initFtpBasePath();
}

/**
 * 连接ftp时保存刚登陆ftp时的路径
 */
private void initFtpBasePath() throws IOException {
    if (StringUtils.isEmpty(ftpBasePath)) {
        synchronized (this) {
            if (StringUtils.isEmpty(ftpBasePath)) {
                ftpBasePath = ftpClient.printWorkingDirectory();
            }
        }
    }
}

/**
 * ftp是否处于连接状态，是连接状态返回&lt;tt&gt;true&lt;/tt&gt;
 * @return boolean  是连接状态返回&lt;tt&gt;true&lt;/tt&gt;
 */
public boolean isConnected() {
    return ftpClient.isConnected();
}

/**
 * 上传文件到对应日期文件下，
 * 如当前时间是2018-06-06，则上传到[ftpBasePath]/[DAILY_FILE_PATH]/2018/06/06/下
 * @param fileName    文件名
 * @param inputStream 文件输入流
 */
public String uploadFileToDailyDir(String fileName, InputStream inputStream) throws IOException {
    changeWorkingDirectory(ftpBasePath);
    SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;/yyyy/MM/dd&quot;);
    String formatDatePath = dateFormat.format(new Date());
    String uploadDir = DAILY_FILE_PATH + formatDatePath;
    makeDirs(uploadDir);
    storeFile(fileName, inputStream);
    return formatDatePath + &quot;/&quot; + fileName;
}

/**
 * 根据uploadFileToDailyDir返回的路径，从ftp下载文件到指定输出流中
 * @param dailyDirFilePath 方法uploadFileToDailyDir返回的路径
 * @param outputStream     输出流
 */
public void downloadFileFromDailyDir(String dailyDirFilePath, OutputStream outputStream) throws IOException {
    changeWorkingDirectory(ftpBasePath);
    String ftpRealFilePath = dailyDirFilePath;
    ftpClient.retrieveFile(ftpRealFilePath, outputStream);
}

/**
 * 获取ftp上指定文件名到输出流中
 * @param ftpFileName 文件在ftp上的路径  如绝对路径 /home/ftpuser/123.txt 或者相对路径 123.txt
 * @param out         输出流
 */
public void retrieveFile(String ftpFileName, OutputStream out) throws IOException {
    try {
        FTPFile[] fileInfoArray = ftpClient.listFiles(ftpFileName);
        if (fileInfoArray == null || fileInfoArray.length == 0) {
            throw new FileNotFoundException(&quot;File &apos;&quot; + ftpFileName + &quot;&apos; was not found on FTP server.&quot;);
        }

        FTPFile fileInfo = fileInfoArray[0];
        if (fileInfo.getSize() &gt; Integer.MAX_VALUE) {
            throw new IOException(&quot;File &apos;&quot; + ftpFileName + &quot;&apos; is too large.&quot;);
        }

        if (!ftpClient.retrieveFile(ftpFileName, out)) {
            throw new IOException(
                    &quot;Error loading file &apos;&quot; + ftpFileName + &quot;&apos; from FTP server. Check FTP permissions and path.&quot;);
        }
        out.flush();
    } finally {
        closeStream(out);
    }
}

/**
 * 将输入流存储到指定的ftp路径下
 * @param ftpFileName 文件在ftp上的路径 如绝对路径 /home/ftpuser/123.txt 或者相对路径 123.txt
 * @param in          输入流
 */
public void storeFile(String ftpFileName, InputStream in) throws IOException {
    try {
        if (!ftpClient.storeFile(ftpFileName, in)) {
            throw new IOException(
                    &quot;Can&apos;t upload file &apos;&quot; + ftpFileName + &quot;&apos; to FTP server. Check FTP permissions and path.&quot;);
        }
    } finally {
        closeStream(in);
    }
}

/**
 * 根据文件ftp路径名称删除文件
 * @param ftpFileName 文件ftp路径名称
 */
public void deleteFile(String ftpFileName) throws IOException {
    if (!ftpClient.deleteFile(ftpFileName)) {
        throw new IOException(&quot;Can&apos;t remove file &apos;&quot; + ftpFileName + &quot;&apos; from FTP server.&quot;);
    }
}

/**
 * 上传文件到ftp
 * @param ftpFileName 上传到ftp文件路径名称
 * @param localFile   本地文件路径名称
 */
public void upload(String ftpFileName, File localFile) throws IOException {
    if (!localFile.exists()) {
        throw new IOException(&quot;Can&apos;t upload &apos;&quot; + localFile.getAbsolutePath() + &quot;&apos;. This file doesn&apos;t exist.&quot;);
    }

    InputStream in = null;
    try {
        in = new BufferedInputStream(new FileInputStream(localFile));
        if (!ftpClient.storeFile(ftpFileName, in)) {
            throw new IOException(
                    &quot;Can&apos;t upload file &apos;&quot; + ftpFileName + &quot;&apos; to FTP server. Check FTP permissions and path.&quot;);
        }
    } finally {
        closeStream(in);
    }
}

/**
 * 上传文件夹到ftp上
 * @param remotePath ftp上文件夹路径名称
 * @param localPath  本地上传的文件夹路径名称
 */
public void uploadDir(String remotePath, String localPath) throws IOException {
    localPath = localPath.replace(&quot;\\\\&quot;, &quot;/&quot;);
    File file = new File(localPath);
    if (file.exists()) {
        if (!ftpClient.changeWorkingDirectory(remotePath)) {
            ftpClient.makeDirectory(remotePath);
            ftpClient.changeWorkingDirectory(remotePath);
        }
        File[] files = file.listFiles();
        if (null != files) {
            for (File f : files) {
                if (f.isDirectory() &amp;&amp; !f.getName().equals(&quot;.&quot;) &amp;&amp; !f.getName().equals(&quot;..&quot;)) {
                    uploadDir(remotePath + &quot;/&quot; + f.getName(), f.getPath());
                } else if (f.isFile()) {
                    upload(remotePath + &quot;/&quot; + f.getName(), f);
                }
            }
        }
    }
}

/**
 * 下载ftp文件到本地上
 * @param ftpFileName ftp文件路径名称
 * @param localFile   本地文件路径名称
 */
public void download(String ftpFileName, File localFile) throws IOException {
    OutputStream out = null;
    try {
        FTPFile[] fileInfoArray = ftpClient.listFiles(ftpFileName);
        if (fileInfoArray == null || fileInfoArray.length == 0) {
            throw new FileNotFoundException(&quot;File &quot; + ftpFileName + &quot; was not found on FTP server.&quot;);
        }

        FTPFile fileInfo = fileInfoArray[0];
        if (fileInfo.getSize() &gt; Integer.MAX_VALUE) {
            throw new IOException(&quot;File &quot; + ftpFileName + &quot; is too large.&quot;);
        }

        out = new BufferedOutputStream(new FileOutputStream(localFile));
        if (!ftpClient.retrieveFile(ftpFileName, out)) {
            throw new IOException(
                    &quot;Error loading file &quot; + ftpFileName + &quot; from FTP server. Check FTP permissions and path.&quot;);
        }
        out.flush();
    } finally {
        closeStream(out);
    }
}

/**
 * 改变工作目录
 * @param dir ftp服务器上目录
 * @return boolean 改变成功返回true
 */
public boolean changeWorkingDirectory(String dir) {
    if (!ftpClient.isConnected()) {
        return false;
    }
    try {
        return ftpClient.changeWorkingDirectory(dir);
    } catch (IOException e) {
    }

    return false;
}

/**
 * 下载ftp服务器下文件夹到本地
 * @param remotePath ftp上文件夹路径名称
 * @param localPath  本地上传的文件夹路径名称
 */
public void downloadDir(String remotePath, String localPath) throws IOException {
    localPath = localPath.replace(&quot;\\\\&quot;, &quot;/&quot;);
    File file = new File(localPath);
    if (!file.exists()) {
        file.mkdirs();
    }
    FTPFile[] ftpFiles = ftpClient.listFiles(remotePath);
    for (int i = 0; ftpFiles != null &amp;&amp; i &lt; ftpFiles.length; i++) {
        FTPFile ftpFile = ftpFiles[i];
        if (ftpFile.isDirectory() &amp;&amp; !ftpFile.getName().equals(&quot;.&quot;) &amp;&amp; !ftpFile.getName().equals(&quot;..&quot;)) {
            downloadDir(remotePath + &quot;/&quot; + ftpFile.getName(), localPath + &quot;/&quot; + ftpFile.getName());
        } else {
            download(remotePath + &quot;/&quot; + ftpFile.getName(), new File(localPath + &quot;/&quot; + ftpFile.getName()));
        }
    }
}

/**
 * 列出ftp上文件目录下的文件
 * @param filePath ftp上文件目录
 */
public List&lt;String&gt; listFileNames(String filePath) throws IOException {
    FTPFile[] ftpFiles = ftpClient.listFiles(filePath);
    List&lt;String&gt; fileList = new ArrayList&lt;&gt;();
    if (ftpFiles != null) {
        for (int i = 0; i &lt; ftpFiles.length; i++) {
            FTPFile ftpFile = ftpFiles[i];
            if (ftpFile.isFile()) {
                fileList.add(ftpFile.getName());
            }
        }
    }

    return fileList;
}

/**
 * 发送ftp命令到ftp服务器中
 * @param args ftp命令
 */
public void sendSiteCommand(String args) throws IOException {
    if (!ftpClient.isConnected()) {
        ftpClient.sendSiteCommand(args);
    }
}

/**
 * 获取当前所处的工作目录
 */
public String printWorkingDirectory() {
    if (!ftpClient.isConnected()) {
        return &quot;&quot;;
    }

    try {
        return ftpClient.printWorkingDirectory();
    } catch (IOException e) {
        // do nothing
    }

    return &quot;&quot;;
}

/**
 * 切换到当前工作目录的父目录下
 */
public boolean changeToParentDirectory() {

    if (!ftpClient.isConnected()) {
        return false;
    }

    try {
        return ftpClient.changeToParentDirectory();
    } catch (IOException e) {
        // do nothing
    }

    return false;
}

/**
 * 返回当前工作目录的上一级目录
 */
public String printParentDirectory() {
    if (!ftpClient.isConnected()) {
        return &quot;&quot;;
    }

    String w = printWorkingDirectory();
    changeToParentDirectory();
    String p = printWorkingDirectory();
    changeWorkingDirectory(w);

    return p;
}

/**
 * 创建目录
 * @param pathname 路径名
 */
public boolean makeDirectory(String pathname) throws IOException {
    return ftpClient.makeDirectory(pathname);
}

/**
 * 创建多个目录
 */
public void makeDirs(String pathname) throws IOException {
    pathname = pathname.replace(&quot;\\\\&quot;, &quot;/&quot;);
    String[] pathnameArray = pathname.split(&quot;/&quot;);
    for (String each : pathnameArray) {
        if (StringUtils.isNotEmpty(each)) {
            ftpClient.makeDirectory(each);
            ftpClient.changeWorkingDirectory(each);
        }
    }
}

/**
 * 关闭流
 */
private static void closeStream(Closeable stream) {
    if (stream != null) {
        try {
            stream.close();
        } catch (IOException ex) {
            // do nothing
        }
    }
}

/**
 * 关闭ftp连接
 */
public void disconnect() {
    if (null != ftpClient &amp;&amp; ftpClient.isConnected()) {
        try {
            ftpClient.logout();
            ftpClient.disconnect();
        } catch (IOException ex) {
            // do nothing
        }
    }
}
public static void main(String[] arg) throws IOException {
        FtpCli ftpCli = FtpCli.createFtpCli(&quot;192.168.191.70&quot;, &quot;administrator&quot;, &quot;admin&quot;);
        ftpCli.connect();
        ftpCli.download(&quot;123/test.txt&quot;,new File(&quot;d:/test1.txt&quot;));
    }
}
</code></pre>
      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/Blog/categories/java-ee/">java ee</a>
  </div>

        
  
  <div class="tags">
    <a href="/Blog/tags/ftp/">ftp</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>

  
      <div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=123456789012345";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

<div class="fb-comments" data-href="https://josephagk.github.io/2018/12/12/ftp工具类/index.html" data-num-posts="5" data-width="840" data-colorscheme="light"></div>
      
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:josephagk.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/Blog/categories/concurrent/">concurrent</a><small>1</small></li>
  
    <li><a href="/Blog/categories/idea/">idea</a><small>3</small></li>
  
    <li><a href="/Blog/categories/java-ee/">java ee</a><small>2</small></li>
  
    <li><a href="/Blog/categories/java-se/">java se</a><small>5</small></li>
  
    <li><a href="/Blog/categories/mysql/">mysql</a><small>2</small></li>
  
    <li><a href="/Blog/categories/springmvc/">springmvc</a><small>2</small></li>
  
    <li><a href="/Blog/categories/前端/">前端</a><small>3</small></li>
  
    <li><a href="/Blog/categories/加密/">加密</a><small>1</small></li>
  
    <li><a href="/Blog/categories/工具/">工具</a><small>1</small></li>
  
    <li><a href="/Blog/categories/日志/">日志</a><small>2</small></li>
  
  </ul>
</div>




  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/Blog/tags/Interceptor/">Interceptor</a><small>1</small></li>
  
    <li><a href="/Blog/tags/class/">class</a><small>5</small></li>
  
    <li><a href="/Blog/tags/email/">email</a><small>1</small></li>
  
    <li><a href="/Blog/tags/ftp/">ftp</a><small>1</small></li>
  
    <li><a href="/Blog/tags/hash/">hash</a><small>1</small></li>
  
    <li><a href="/Blog/tags/idea/">idea</a><small>2</small></li>
  
    <li><a href="/Blog/tags/logback/">logback</a><small>1</small></li>
  
    <li><a href="/Blog/tags/select2冲突/">select2冲突</a><small>1</small></li>
  
    <li><a href="/Blog/tags/software/">software</a><small>1</small></li>
  
    <li><a href="/Blog/tags/sql/">sql</a><small>2</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2018 JosephGK
  
</div>

<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/Blog/js/jquery.imagesloaded.min.js"></script>
<script src="/Blog/js/gallery.js"></script>




<link rel="stylesheet" href="/Blog/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/Blog/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
